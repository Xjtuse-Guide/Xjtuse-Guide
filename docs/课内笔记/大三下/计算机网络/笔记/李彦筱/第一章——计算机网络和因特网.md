# 第一章——计算机网络和因特网

> 易俊泉学长的原始笔记链接如下：
>
> [第一章——计算机网络和因特网](https://github.com/yijunquan-afk/XJTUSE-NOTES/blob/master/%E5%A4%A7%E4%B8%89%E4%B8%8B/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/Chapter%201%20Computer%20Networks%20and%20the%20Internet/Chapter%201%20Computer%20Networks%20and%20the%20Internet.md)

## 概述

> 互联网是什么?
>
> 什么是协议protocol?
>
> 网络边缘;主机、接入网络、物理媒体
>
> 网络核心:分组/电路交换，Internet结构
>
> 性能:丢失、延迟、吞吐量
>
> 安全
>
> 协议层，服务模型
>
> 历史

## 什么是因特网

因特网（Internet）是一个世界性的、公共的计算机网络，它将一个个小的网络互联起来，形成一个世界性的大网络。

> A network that interconnects millions of computing devices throughout the world

<mark>**因特网的组成**</mark>: **edges 边缘、端系统，core 内核 and links 链路**（将端系统和内核连接起来）

硬件：端系统、内核与链路

软件：协议和互联网软件，互联网系统（帮助你处理大端表示/小端表示区别之类的问题）

### 因特网组成

#### Hardware

![image-20250317092215085](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOJaJAaPu47bCnOFZ71PmanRr86SbQAAmQVAAIh_YBU2yeYkvObfxk2BA.png)

x 号：路由器；红色三角：AP（无线路由器）；其他符号为 PC 和笔记本。

:one: **Hosts/Ends systems**（端系统）：主机=端系统——运行网络应用程序的终端

:two: **Core**（内核）: routers 路由器——负责转发数据包(数据块)

> 内核是由若干个路由器组成的 mesh (网)。路由器一般是有线的，而且挺贵的。
>
> 我们常用的 Wi-Fi 的所谓「路由器」其实是 AP（Access Point，无线接入点），价格比真正的路由器（交换机）低多了，可以在家里放一大堆，让更多主机无线接入网络。

:three: **Links**：通信链路

> 光纤 fiber，铜，无线电 radio，卫星，局域网 LAN 等内容都是通信链路
>
> 传输速率=带宽

#### Software

Protocols & App：协议提供通信支撑

> 协议控制 message（翻译为报文而非消息）的发送、接收、转发
>
> package 翻译为分组而非包。

![image-20220404213343943](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOKaJAahUG4meTslBJRYIG2pfEbpwQAAmUVAAIh_YBUHpZ0MUfZD6k2BA.png)

**因特网是网中网/网间网，是松散分层的**。宿舍中使用的无线局域网接入因特网，但显然宿舍的局域网中只包含宿舍同学的设备，不包含其他人的设备。这说明宿舍局域网和因特网是**不同层的**。

> 公共因特网 Internet 与私人内部网 intranet
>
> 私人内部网是指不连接因特网的局域网络，协议也是 IP 协议，内部可以进行和因特网类似的通信，但无法向外界发送或接收信息。

**因特网标准**（数据传输标准等内容）

> RFC:  Request for comments 意即“征求意见”，包含了关于 Internet 的几乎所有重要的文字资料。
>
> 一个单位提出 RFC 且形成标准（被 IETF 通过后），所有网络通信都需要遵守这个 RFC 标准。
>
> 由 Internet 工程委员会“因特网工程师任务组” IETF 以及 IETF 下属的“因特网工程师指导组” IESG 定义

### 服务角度

因特网是提供服务的通信基础设施（Communication Infrastructure）：

> 因特网通信可以用于实现分布式的应用，比如：
>
> 网络，网络电话（VoIP），电子邮件，游戏，电子商务，文件共享

因特网为应用程序提供的通信服务:

> :one: 可靠的数据传递：TCP 协议
>
> 可靠的含义：传输的数据不会丢失、传递到应用层的顺序不会乱。但不保证每次发送时的内容都发在一个包中。
>
> :two: 不可靠的数据传递：UDP 协议
>
> 不可靠的含义：传输的数据包可能丢失，数据可能会乱，但是保证你每次发送的内容都打成一个包发送。
>
> 两个协议的特点：**“best effort” 尽力而为**，尽最快的速度传输。（但 UDP 不能保证不丢包）

## 协议 protocol

<mark>协议</mark>定义了报文的**格式、命令以及报文传输和接收时所采取的行动**

只需要记忆三个要素：协议= **格式**+**命令**+**行动**（收到信息后采取什么样的行动）

> Protocol={*format*格式, *order*命令, *actions*动作}  ={syntax语法,semantic语义,rules规则}
>
> 规则：收到的内容满足 xx 条件时我要做 yy，和「行动」概念相同。

因特网上的所有通信活动都受协议控制，都需要协议约定。

协议在 Internet 中无处不在，不同的协议被用来完成不同的通信任务

## 因特网边缘 edges

**端系统(主机)**

所有系统都运行在端系统上（不管是前端还是后端），网络只起通信作用。例如电子邮件服务、网站服务都在后端上运行。

端系统上承载了各种这样的应用，其相互的通信方式有如下几种：

**客户机/服务器模型（C/S）**

客户端主机发起请求，从永远在线的服务器接收服务、消息

例如 Web浏览器/服务器（B/S 模式）;电子邮件客户机/服务器

B/S 模式是 C/S 模式的一种特例（客户端为浏览器）

**对等模型P2P**:

最少(或不)使用专用服务器；即两端之间**完全对等**，没有客户端/服务器的差别。

例如 Skype，BitTorrent 等两台电脑直接连接的方法。

**终端系统如何连接到边缘路由器?**

Internet 网络的特征：**胖边缘，瘦内核**，即外围接入的边缘设备相当多，但核心（负责转发数据的路由器）数量较少。

> 互联网的大部分功能由边缘设备提供，主要是各个网络服务器

其他网络（比如 PSTN，电话网络）属于胖内核，瘦边缘。这种网络中，边缘设备只需要支持接打电话，而内核设备要考虑的就多了，比如电话计费，转接等。

常见的入网类型可以分为三种：

> 住户接入网络
>
> 机构接入网(学校、公司)
>
> 移动接入网络（即无线接入网络）

常见概念：

bps：bits per second，bit 每秒，用于表示网络的带宽。

> 我们使用的「千兆网络」其实是 1000Mbps，就是 1000Mb/s，其实只有 125MB/s。

专用/共享：网络带宽是专用的还是共享的。

> 很遗憾，大部分家用宽带都是共享的，还超售（很可能 1000Mbps 的带宽卖出 15 个 100Mbps 的套餐，然后大家都用的时候就一起卡）

串行/并行通信：不同的连接方式

串行通信：数据需要一位接一位的发送

并行通信：一端数据可以分为几部分同时发送。

USB 设备和网络通信都是串行通信（网络通信指单个连接中是串行的，如果电脑上有不下 20 个应用同时通信，那总体来说确实是并行的）。

### 接入网

接入网，这是指将端系统物理连接到其边缘路由器(edge router)的网络。

边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器。

#### 家庭入网方式

> 宽带入网的两种流行方式：数字用户线 DSL 和电缆
>
> 新兴技术：FTTH 光纤入户（在 20 年前的新兴技术）

##### Dial-up Modem 拨号调制解调器

![image-20220118114703466](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOUaJAhI0487sM9m3m67Ubm1iqAi7gAAtnHMRsh_YBUhJgWgmv_D7UBAAMCAAN4AAM2BA.png)

使用现有的电话基础设施，通过调制解调器编制/解码信号，以便信号传输的较远且不受干扰。

> Home 与中心办公室相连，从中心办公室进入电话网络，再从电话网络通过 ISP 进入互联网。
>
> 按时间收费，和电话一样，价格实在是有点爆炸
>
> 最高达 56Kbps 的带宽(通常更少)
>
> 不能同时上网和打电话（因为上网时要把电话线拔出来接猫），不能“一直开机”

##### Asymmetric Digital Subscriber Line (ADSL) 非对称数字用户线

不对称是指上行带宽和下行带宽不对称。上行链路（家庭给服务商）带宽窄，下行链路（服务商给家庭）带宽宽

ISP: 网络服务提供者（Internet Server Provider）

![2325c704415ee43fe1d455bf63b3dba4](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOLaJAasbx5yvSC6UztGNcBAexMFHMAAmYVAAIh_YBUmZWmj1s4S_w2BA.png)

> 也使用现有的电话基础设施
>
> 最高可达 1Mbps (通常小于 256kbps)
>
> 下行 8Mbps (通常小于 1Mbps)
>
> 专用物理线路到电话中心办公室

上网时，先用 DSL modem 对信号调制，信号到达中央办公室后解调，再进入互联网。信号可以通过电话网络进行传输，或者直接进入互联网。

ADSL 和拨号调制解调器入网**都是独享带宽的**。

##### HFC 混合光纤同轴电缆

> Hybrid fiber coax

这个名称描述了一种通信线路：光线和同轴电缆混合的传输线路。家中的信号线路是同轴电缆 10Mbps，家外部分是光纤（传输更快）。

> 国内从来没有使用过这种传输

需要光电转换设备，也是不对称的，下行带宽最多 30Mbps，上行最多 2Mbps。

HFC 带宽是**共享带宽的**。

HFC 方法也需要调制解调器实现信号传输。多个家庭的同轴电缆传输信号混合起来，通过几个光电转换节点转换为光信号，传输到服务商处。

![image-20220118115610294](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOVaJAhKWc5blhOte0jsj_CjBDzjs0AAtrHMRsh_YBUnhDKBNlgE28BAAMCAAN5AAM2BA.png)

以上三种方法**都需要调制解调器**。

##### FTTH：Fiber to the Home 光纤入户

从本地中心局直接到家庭提供了一条光纤路径；每个家庭都接入一条光纤。光纤可以用于电视，电话或上网。

![image-20220118115850169](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOWaJAhLfmsTsNfgstDddwD33EcxNwAAtvHMRsh_YBUWZ3VLtTVvUgBAAMCAAN5AAM2BA.png)

速度非常快，可以达到 Gbps 级别。

#### 企业（和家庭）接入

##### 以太网 Ethernet Internet access

![image-20220302142709496](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOXaJAhNEP1fMiFmCpWHEJY5TLTShIAAtzHMRsh_YBU58trBxwhX6YBAAMCAAN4AAM2BA.png)

通常用于公司、大学等

10mbps, 100Mbps, 1Gbps, 10Gbps 以太网

现在，终端系统通常连接到以太网交换机。内网的速度取决于交换机的带宽。

##### Wireless access networks 无线接入

![image-20220302142741843](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOYaJAhN6xF39eHyoMWKhBuwS7MS48AAt3HMRsh_YBUtl_j5u8-iEkBAAMCAAN4AAM2BA.png)

路由器发送无线信号，让终端设备能够无线接入网路

> 通过基站（Base Station，对于手机流量）或者 AP（Access Point，接入点，对于 WLAN）接入网络。

有两种方式：

- 无线局域网 WLAN：Wi-Fi

  WLAN 的意思是 Wireless LAN（Local Area Network），即无线局域网；Wi-Fi 是 WLAN 技术的一个子类，包含 802.11b/g 系列的多种网速标准。

  在现实中，似乎没人区分 WLAN 和 Wi-Fi……

- wider-area wireless access：运营商提供（即移动网络，流量）：4g/5g

这两种方式就对应我们生活中手机常用的流量/Wi-Fi。

### Physical Media 物理媒介

物理媒介分为两种：

- **有向方式媒介 guided media**，如光缆、双绞铜线或同轴电缆

  线缆类的介质基本都是有向的，因为你都有线路限制了就很难多个方向发送数据了。

- **无向方式媒介 unguided media**：电波在空气或外层空间中传播，如无线局域网

#### 双绞铜线 Twisted Pair (TP)

最便宜而且最常用，电话线就是双绞铜线

分为不同种类：C5, C6, C6+，数字表示每英尺缠绕多少圈，缠绕越多，信号越不容易受干扰。

> 大部分情况下，网速都受交换机限制而不是网线限制；不过，网线太差了还是跑不起来的，比如千兆网络在 3 类线上跑不了……

#### 同轴电缆 Coaxial cable

单通道电缆，在上面讲的 HFC 方案中有用，用于老式的以太网。现在网络中几乎不使用这个了。

同轴电缆的带宽不太够，如果需要连接大量设备，就需要多根同轴电缆一起铺设，通过中继器在多根电缆之间通信。

需要中继器放大信号，否则电缆上的信号最多传播 180 米就会丢失。

#### 光纤电缆 Fiber optic cable

利用玻璃纤维传递光脉冲，每个脉冲一个比特。每段时间内有光线表示 1，没有光线表示 0。

光纤是现在最常用的网络通信介质。

**优点**：

- 衰减度很低
- 带宽很宽，最快可以超过 100Gbps
- 抗电磁信号等干扰的能力强（光怎么能被电磁信号干扰呢）
- 安全性强（不能无损的把光纤拆开，接上一段窃听信息）

> 无线通信的衰减度是最高的，受干扰程度也是最高的，也是最不安全的，唯一的优点倒是非常大：不需要拉根超长的线！

#### 无线电类型（无向媒介的一种）

最大的好处：不受线的束缚

缺点：衰减度高，安全性低（任何人有个接收设备就能获得数据），受干扰程度高，容易被干扰/遮挡（比如楼是可以挡住信号的）。

> 也就是除了带宽没问题之外，光纤不存在的问题它都有

此外，还存在多次数据传输的问题：发送端发送的信号经过长度不同的多路，可能在不同时间多次到达接收端，接收端需要处理这种情况。

无线电的主要类型如下：

###### 地面微波

例如高达 45Mbps 的频道

##### WLAN(例如无线网络)

11Mbps, 54 Mbps,300+Mbps

##### 广域(如手机)

4G/5G cellular: 1G-10+Gbps

##### 卫星

Kbps 至 45Mbps 频道(或多个较小频道)

存在 270ms 左右的的端到端延迟（上传到卫星/从卫星下载延迟就有 270ms），RTT（Round Trip Time，往返延迟）就有 540ms。

## 网络内核

<mark>网络内核是由**路由器**互联组成的网</mark>

> 路由器基本上指的是交换机，不是家里用的无线路由器，家里那种叫 AP。

主要部件是路由器：保证数据包走最优路径到目标端

<mark>**数据交换方式**</mark>

> :one: **电路交换 circuit switching**：使用电话拨号,信号从发送端直接发送到接收端，一位位传，实时性比较好
>
> :two: **分组交换 packet-switching**：路由器采用的方法，不需要拨号，将数据封装成小包，放到路由器的队列中。排到之后，将数据包放到正确的数据端口，发送到下一个路由器的端口。
>
> 其核心为**存储转发**。存储：数据包排队的过程；转发：找到正确的输出端口并发送。
>
> :three: **虚电路交换**：数据按照包传输，但是需要拨号，拨号的过程就是链路建立的过程，没有一根线连起来，中间交换设备会将资源准备好。ATM 网络采用这种交换方式。

### 电路交换

必须进行拨号，拨号的过程是资源预留的过程，拨通了才能传输数据。打电话就是这个方式。

资源预留后，就是发出者专用的；哪怕发出者什么都不发，还是需要消耗资源。

电路交换是直通的：发送端的信号会直接传输到接收端，不需要转发设备。

![image-20220302145306543](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOSaJAbaLXun2AvGZO0ERtJS6ecbSoAAm8VAAIh_YBUs5dG_sY3gCc2BA.png)

每个呼叫接通后，会分配到一部分资源（带宽）。

#### 资源的分配方式

通信资源被分为很多“片”，可以给多个用户使用。但无论用户是否真的在传输，只要建立了链接，分配给用户的资源就无法给其他用户使用。

资源的常用分片方式有两种： FDMA 频分复用（按频率划分）、TDMA （按时间划分）。

![image-20220302145617686](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOMaJAa3tf2oiBa-jf2zyPNbwQPlhIAAmcVAAIh_YBUsd4Miu28pas2BA.png)

FDMA（frequency division multiplex access，频分多路访问）：按照频率划分资源，比如 HFC，不同用户使用不同频率传输数据。再比如 ADSL，上行/下行带宽不对称的网络中，上行/下行网络的带宽不同。

上方图中 FDM 的含义如下：

- 将频率划分为多个频段，每个频段在某个时刻只能给一个用户使用，因此只要有用户在使用一个频段，这个频段其他人就用不了了；

TDM 的含义如下：

- 将时间划分为多个时间片，多个用户轮流占用时间片发送数据；一个用户在一个时间片内发不完数据的话，就等下个时间片（类似 RR 调度）

再比如，Wi-Fi 通信也是使用 FDMA 划分的。路由器有多种无线信道可选，每个信道都对应了一种频率，不同路由器可以选择不同信道传输数据。

TDMA：时分多路访问，用于电话

CDMA：按伪码划分

WDM：按波长划分，用于光通信。

**Internet 的资源划分方式是“统计复用”，不属于上面四种的任何一种。**

> 频分复用和时分复用都会为每个已经建立连接的客户端-服务器预留连接带宽，即使它们没有传输任何内容。同样的，正在传输的客户端-服务端连接也不能使用其他的频段，即使那个频段没有人在用

**举例**

> 通过电路交换网络，从主机A发送一个64万比特的文件到主机B需要多长时间?
>
> 所有链路的带宽为1.536 Mbps
>
> 每条链路使用24slots/sec的时分复用(TDM)
>
> 500毫秒建立端到端电路
>
> **注意“比特”是位的意思(b)；字节才是正常的 B**。
>
> 解答：
>
> 64000 bit = 0.64 Mb（注意不是 MB）；总带宽分为 24 个链路，那么每个链路的带宽就是 1.536 / 24 = 0.064 Mbps（注意不是 MBps）。
>
> 虽然其他链路时间片可能没人用，但你只能用一个时间片，因此你的带宽只有 1.536 / 24 = 0.064，其他带宽都算是浪费了。
>
> 数据传输：0.64Mb/ (1.536 Mbps / 24) = 0.64Mb / 0.064Mbps = 10 (s)
>
> 总时长：10s+0.5s=10.5s（0.5s 用于建立连接）

### 分组交换

因特网的网络内核使用到的就是分组交换。

分组交换的名称是 Packet Switching，不要翻译成「包交换」啥的了。

ipv6 网络允许进行资源预留：用户可以要求一定带宽，即使自己当前使用带宽不足要求的带宽，还是会完全保留要求的带宽（当然，需要加钱）；ipv4 网络不能实现此操作，只能在发送时占用实际占用的带宽；如果主干网负载太大，所有人上网都会慢。

为了从源端系统向目的端系统发送一个报文，源将长报文划分为较小的数据块，称之为分组（packet）。在源和目的地之间，每个分组都通过**通信链路和分组交换机**（packet switch）传送。（交换机主要有两类：**路由器（router）**和**链路层交换机（link-layer switch）**。）分组以等于该链路最大传输速率的速度传输通过通信链路

#### 存储转发传输

**存储转发**（Store-and-forward）指的是路由器（交换机）在向输出链路传输该包的第一个 bit 前必须等待包中的所有内容到达队列。即需要等待此包的内容传输完成后，才能转发，不能边接收边转发。

![image-20220302152831810](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAONaJAa8NNvZnvOcJbQgWkWhJlsvkcAAmgVAAIh_YBUNe2u4fi5-m02BA.png)

如上图：发送L位的包，中间有两个路由器，三个链路，带宽为R

总共花费的时间是三倍的 L/R，即相当于三段发送过程是串行的，在包完全到达下一个路由器前，下一个路由器无法转发内容。

比如，发送一个 7.5Mb 的包，每段链路的带宽都是 1.5Mb/s，那么需要 3 * 7.5 / 1.5 = 15s 的时间。这实在太长了，而且每增加一个路由器，速度就慢一点，这简直太恐怖了。

解决方法（减少时间的方法）：减小包的大小。当每个包大小从 7.5Mb 减小到 1.5kb 时，只需要 1ms 就可以转发一次，总共 3ms 即可到达接收端；当前一个包经过 1ms 被下一个路由器接收后，下一个包就可以发送了，因此每毫秒都有个 1.5kb 的包到达终点，速度大概到达了 1.5Mb/s，只需要 5s 就可以完成传输了。

> 将包大小减少可以大幅降低路由器为了实现存储转发，等待包传输完成的时间，从而增加传输速度。

#### 统计复用

分组交换资源使用的方式是：<mark>**统计复用 statistical multiplexing**（因特网内核资源使用方式）</mark>

指的是多个用户都可以发送数据，最终按照实际使用量去计算，资源没有划分开；用户不能要求预留部分带宽资源，只能“拿到多少带宽算多少”。

![image-20220302152434887](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOOaJAbATOw_AbYqz9_zScq49FKkfYAAmkVAAIh_YBUsUmEgbQ5OS82BA.png)

图中 A、B 到 D 数据传输的最大带宽是1.5Mb/s，因为瓶颈位于 AB -> C 的网线处，速度无法超过 1.5Mb/s。

### 电路交换与分组交换的比较

假设链路带宽为 1Mb/s，每个用户使用带宽为 100kb/s，每次使用10%的时间

对于电路交换，最多容纳10位用户

对于分组交换，可以容纳35个用户以上

> 电路交换：每个用户预留带宽，即使不用也不能给其他人
>
> 分组交换：你的网络通信发送速度是多少，带宽就是多少。带宽是动态分配的，因此可以让更多用户上网（总有用户是买了宽带但暂时不用网的）
>
> 不过可恶的运营商经常超售带宽，导致大家都在上网时 300M/500M 的宽带还是 10MB/s 的速度，太可恶了；要是家用网络是电路交换就无所谓了。

ATM：虚拟电路交换（Asynchronous transfer mode，异步传输技术）

> ATM 网络主要用于实时语音通信等用途，因此为了实时性，包大小特别小；在传输层章节中，我们会再次遇到 ATM 网络。

这种方法包特别小，在存储转发时速度很快，而且需要拨号，因此传输速度较快。

ATM 网络是介于电路交换和分组交换之间的网络，速度和实时性（延迟）也介于两者之间。当然比不上连打包都不用打的电路交换）。

不过现在 ATM 网络已经完全没有人使用了。

:one: <mark>分组交换允许更多的用户使用网络</mark>

分组交换的承载量远远大于电路交换和 ATM。

:two: 分组交换适用于突发数据

> 发送大量数据时，由于存储转发的存在，在带宽不足时路由器会暂时存储发送的数据然后慢慢发送，不会导致数据直接丢失。

:three: 分组交换资源利用率高

> 用户只占用实际使用的带宽，不用网络时，闲置的带宽可以给其他用户

:four: 分组交换技术比较简单（没有拨号等繁琐的启动步骤）

缺点：

1. 用户量较大，超过总带宽时：网络延迟变长，且可能出现丢包。

2. 由于包经过每个路由器都需要存储转发，实时性不好（转发时可能需要排队）

   > 实时性不如电路交换：电路交换拨号之后都不需要分包，直接发就行了

### 因特网架构——网中网

有许多一级服务商，每个一级服务商建立骨干网，并且和其他服务商的骨干网互通，每个一级服务商对应许多二级服务商，每个二级服务商对应许多本地服务商。

各个二级服务商既可以通过自身一级服务商相连，也可以直接互联。

![image-20220120174257475](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOZaJAhS-9FmY-6Z2__aVD3dSbj6BwAAt7HMRsh_YBUYKcklr9GerYBAAMCAAN3AAM2BA.png)

## 分组交换网中的延时、丢包和吞吐量

### 延时 delay

#### 丢包和延迟何时发生

数据包需要在路由器缓冲区中排队，等待存储转发。如果数据包到达链路速度超过了链路的输出速度，就需要排队等待发送。如果路由器的排队队列/缓冲区已满，那么之后到达的包就只能被丢弃，造成丢包。

![image-20220301102936843](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOaaJAhUGgOCMl9C4iccWOpSC4l0JAAAt_HMRsh_YBUA9WSf-WfK-QBAAMCAAN4AAM2BA.png)

#### 类型

![image-20220302154933035](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAObaJAhVBjgCWwEhMX34RsezDddl2UAAuDHMRsh_YBUOv2h0UiAvicBAAMCAAN4AAM2BA.png)

:one: 节点处理延时

> 校验位错误（如果有错误则直接丢弃）、提取 IP，确定输出出口

:two: 排队延时

> 在输出链路上等待传输的时间。取决于路由器的拥塞程度

:three: 传送延时 Transmission delay

> R=从路由器A到路由器B的链路传输速率 (bps)
>
> L=包的位长(bits)
>
> 传送（发出）到链路的时间 = L/R

:four: 传播延时 Propagation delay 

> d =物理链路长度
>
> v =介质中的传播速度($~3\times10^8$m/s)
>
> 传播延时= d/v

注意区分传送延迟和传播延迟：

传送延迟=包大小/带宽，是在传播延迟之外附加的延迟时间（因为要求接受完整个包再转发），也就是等待整个包完成接收需要的时间。

传播延迟=物理链路长度 / 传送速度，即物理介质速度上限导致包发送的延迟。

![image-20220305095744588](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOPaJAbGf7utd1uZbZOtHMObnnBc9MAAmoVAAIh_YBUGgIlPeApC9E2BA.png)

每经历一跳，都会经历这四个延时，处理延时很短很短，可以忽略；包大小一般在 1kb 内，目前带宽都是 Mbps 级别的，传送延时一般小于 1ms，只有 0.1ms，可以忽略不计；大部分传播延时都可以忽略（因为光速真的很快），但卫星电路的传播延时不可忽略。

**排队延时不可忽略**。路由器转发包时，你的包大概率不是第一个到达的包，因此大概率需要排队，且排队时间不短，不能忽略。

对于排队延迟，可以用堵塞程度来描述

R =链路带宽(bps)

L =包大小(bit/包)

a =数据包平均到达速率（包数量/秒）

traffic intensity（业务强度） = L * a/R                             

> La/R ~ 0: 平均排队延迟小
>
> La/R -> 1（接近 1）: 路由器的业务强度濒临极限，延迟变大
>
> La/R > 1: 到达的“工作”比能得到的服务更多，平均延迟无限大，包积累后一定会导致路由器缓冲区不足，从而导致丢包。

> ping 命令的结果：TTL-Time to live：默认为 64，每经过一个路由器，这个值 -1，减到 0 之后服务器直接丢弃此包。这可以防止某个包在路由器之间通过互相发送到默认端口无限转发。
>
> 查看命令返回值的 TTL，使用 64 - TTL 就可以计算出数据包到达电脑前经过的路由器数量。比如 TTL=60 表示数据包经过了 64-60=4 个路由器。
>
> traceroute（Windows 为 tracert）命令可以查询向某个 IP/网址发送数据时，经过的所有路由器。返回 * 值表示路由器屏蔽了此类查询，不返回内容。此命令可以查看发送的包经过了哪些路由器转发。

### 吞吐量

**吞吐量 throughput**: 发送端和接收端之间传输比特的速率(比特/时间单位)，即每秒能传输的 bit 数量，和网速差不多是一个意思。

> 瞬时 instantaneous 速率: 给定时间点的速率
>
> 平均 average 速率: 在较长的一段时间内的比率

![image-20220301102504433](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOQaJAbMSN-jJwyxdZyiuV3r2XvdgIAAmwVAAIh_YBUiBja6wlWgXo2BA.png)

吞吐量取决于 Rs、R 和 Rc 中较小的部分（瓶颈bottleneck），这很显然，毕竟连接速度肯定取决于最慢的传输链路。

![image-20220301103651781](https://telegraph-image-5ms.pages.dev/file/AgACAgUAAyEGAASIfjD1AAOcaJAhXLSMPB7SbyqOEf6CQ9kFM40AAuHHMRsh_YBUm11UAAHmMbC3AQADAgADeAADNgQ.png)

若有n个连接共享R，则吞吐量计算时还要将R➗n来算最小值

## 协议层次及其模型

> Protocol “Layers”

互联网十分复杂，因此采用分层组织，描述更加清晰。

**分层好处**（为什么需要分层？）：

处理复杂系统:明确的结构允许识别复杂系统的各部分的关系；模块化便于系统的维护和更新；在更新某一层时，只需要考虑这一层和上下层的接口就行了，很简单。

**分层有缺点吗？**

层与层之间存在依赖；由于需要逐层传输，传输效率会降低

### 因特网协议栈 TCP/IP 模型

自顶向下，书上将 TCP/IP 网络分为五层。

> TCP/IP 协议：所有 Internet 协议的总称
>
> TCP 协议：一种传输层的数据传输方式
>
> IP 协议：一种网络定位/组织方式
>
> 记住 TCP/IP 协议其实和名字中的两个协议没啥关系，只用来表示所有网络协议的集合。

注意层数是从下往上算的（比如传输层算作第四层而不是第二层）

:five: 应用层 :支持网络应用

> FTP、SMTP、HTTP、应用程序……

:four: 传输层: 过程-过程数据传输

> <mark>TCP（可靠), UDP(不可靠)</mark>——就两个协议

:three: 网络层:数据报从源到目的地的路由

> IP, 路由协议,…

:two: 链路层: （数据链路层）相邻网络元素之间的数据传输

> 将整个帧（数据）从一个网络元素移动到临近的网络元素
>
> PPP、以太网、ADSL、FTTH 、WI-FI……

:one: 物理层: bit "on the wire"

> 物理层的任务和传输 bit 有关，和计算机的关系其实不算大；很多时候，从计算机的角度来看，我们可以把链路层和物理层合成一层看，因为都没什么东西，不太需要学。
>
> 物理层的任务是将链路层中的帧中的一个个bit从一个节点移动到下一个节点

这些层就像**楼**一样，最下面是第一层，最上面是第五层；即**物理层为第一层，应用层为第五层**。别记反了……

同一数据在不同层的名称（PDU）不同（需要记住）：

应用层：报文；传输层：段（Segment）；网络层：包（Package）/数据报（Datagram）；数据链路层：帧（Frame）；物理层：按位为单位（bit），在物理层看来，数据就是分离的一个个字，没有其他含义。

### ISO/OSI 参考模型

> ISO：国际标准化组织
>
> OSI：开放系统互连，一个标准
>
> 将各个局域网互连起来
>
> 非常巧合，ISO 和 OSI 正好是倒过来的。
>
> 在现实中其实没有应用；互联网用的都是 TCP/IP 模型。

相较于 TCP/IP 模型，多了两个层

:label: **表示层**: 允许应用程序解释数据的含义，例如是否需要加密、压缩、特定于机器的约定

:label: **会话层**: 解决同步问题，检查点，恢复数据交换（断点续传）

> 目前都在应用层做表示层和会话层的工作
>
> ==可能的考点：五层模型和七层模型的对应关系；OSI 模型的提出时间为 1984 年==

即在应用层和传输层之间增加了两层：**表示层和会话层**。

![image-20220301105937817](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAOTaJAbfqrtyS-vl6kanIVXid6Zb00AAnAVAAIh_YBUgEBHCzZ5cnc2BA.png)

### 封装

要记住 PDU 在每层中分别是什么（即数据在每层中的称呼各是什么），不能全都叫“包”：（说不定是考点？）

> 应用层：报文
>
> 传输层：段
>
> 网络层：包/数据报
>
> 链路层：帧
>
> 物理层：位

![image-20220505143742929](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AAORaJAbVCmOfMftW1dgGzNgnK2Yyh0AAm4VAAIh_YBUXI6V9Faxw3U2BA.png)

交换机在转发时只需要解析到第二层；路由器转发时需要解析数据包到第三层。因此交换机称为“层 2 转发”，路由器称为“层 3 转发”。

发送数据时，自上而下每层都在报文前添加一个帧头；接收数据时，自下而上每层都去除并解析发送端对应层添加的帧头。因此，这是某种意义上的“层对层通信”（每层都只拿属于自己的帧头数据）

## 因特网发展历史

只需要记住**因特网起源于 1967 年**（一开始叫 ARPANet，用于发电子邮件）

:one: 分组交换的发展：1961-1972

> 最开始是为了发邮件
>
> 1967: ARPAnet

:two: 专用网络和网络互连：1972-1980

> 1983：TCP/IP开始部署 （TCP/IP不只是表示两个协议，而是所有的网络协议，不能少斜杠）

## 练习题

:one: 在新的网络安装中，网络管理员决定使用不受电噪声影响的介质。哪种电缆类型最符合这个标准?

a) coaxial      b)     screened twisted pair        c) shielded twisted pair     d)  unshielded twisted pair        e) fiber optic 

> e) fiber optic 光缆

:two: 选择所需的必要信息，以计算将数据从一个位置传输到另一个位置所需的估计时间。(选择两个。)

a) file size        b) data format      c)   network in use        d) type of medium       e)   bandwidth of the link 

> a)文件大小和e) 带宽

:three: 哪个协议在TCP/IP协议组的网络层起作用?

a) File Transfer Protocol (FTP)     b)  Trivial File Transfer Protocol (TFTP)（不可靠，适用于局域网）   c) Transmission Control Protocol (TCP)   d) Internet Protocol (IP)         e)  User Datagram Protocol (UDP)        f) Simple Mail Transport Protocol (SMTP) 

> d) IP

:four: Which of the following is the Layer 4 PDU?

a) bit      b)  frame       c)  packet         d) segment 

> d) segment

:five: Which OSI layer encapsulates data into packets?

a)  session     b)   transport       c) network     d)   data link  

> c) 网络层

:six: Why are internets necessary? (Choose three.)

a) to overcome LAN scalability limitations           

b) to overcome LAN speed limitations 

c) to overcome LAN distance limitations

d) to prevent collision and congestion conditions 

e) to network networks 

> a) 克服扩展性
>
> c) 克服远距离传输
>
> e) 网间网

## 参考资料

[1] James F.Kurose，Keith W.Ross.Computer Networking—A Top-Down Approach（第6版）.北京：高等教育出版社出版者，2013年。

[2] 西安交通大学Computer Networking2022年春 课程PPT 朱利